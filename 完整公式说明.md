# 双链区块链系统 - 完整公式说明

## 📐 公式体系概览

本系统包含两大核心计算模型：

1. **紧急度评估模型** - 评估紧急交易的优先级
2. **信誉值计算模型** - 评估节点的可信度

---

## 🔥 一、紧急度评估模型

### 1.1 紧急度计算公式

紧急交易的紧急度 `ED` (Emergency Degree) 由以下公式计算：

```
ED = E × e^(ω·θ)
```

**其中**:

#### 基础紧急系数 `E`

```
E = e^(-Tc / (Tr - Tu))
```

**参数说明**:
- `Tc` : 交易期望延迟 = td - ta
- `Tu` : 交易产生时间 = tp
- `Tr` : 交易到达RSU时间 = ta
- `tp` : 交易产生时刻 (Product Time)
- `ta` : 交易到达RSU时刻 (Arrival Time)
- `td` : 交易期望完成时刻 (Deadline Time)

#### 频率惩罚因子

```
频率惩罚 = e^(ω·θ)
```

**参数说明**:
- `θ` (theta): 车辆在此期间已申请的紧急交易数量
- `ω` (omega): 影响权重系数（默认值 **0.5**）

### 1.2 完整展开式

```
ED = e^(-Tc / (Tr - Tu)) × e^(ω·θ)

   = e^[(-Tc / (Tr - Tu)) + ω·θ]

   = e^[(-(td - ta) / (ta - tp)) + ω·θ]
```

### 1.3 紧急度计算示例

**示例1**: 碰撞预警交易

```
已知:
  tp = 10:00:00.000 (产生时间)
  ta = 10:00:00.100 (到达时间，延迟100ms)
  td = 10:00:00.500 (期望完成时间，500ms内完成)
  θ = 2 (车辆已申请2次紧急交易)
  ω = 0.5

计算:
  Tc = td - ta = 0.5 - 0.1 = 0.4 秒
  Tr - Tu = ta - tp = 0.1 秒
  
  E = e^(-0.4 / 0.1) = e^(-4) ≈ 0.0183
  
  频率惩罚 = e^(0.5 × 2) = e^1 ≈ 2.718
  
  ED = 0.0183 × 2.718 ≈ 0.0497
```

**示例2**: 低优先级通知

```
已知:
  tp = 10:00:00.000
  ta = 10:00:01.000 (延迟1秒)
  td = 10:00:10.000 (10秒内完成)
  θ = 0
  ω = 0.5

计算:
  Tc = 10 - 1 = 9 秒
  Tr - Tu = 1 秒
  
  E = e^(-9/1) = e^(-9) ≈ 0.0001234
  
  频率惩罚 = e^(0.5 × 0) = e^0 = 1
  
  ED = 0.0001234 × 1 ≈ 0.0001234
```

---

## 📊 二、信誉值计算模型

### 2.1 信誉值总体计算

节点 `i` 在时刻 `t` 的信誉值:

```
R(i, t) = T + γ·I
```

**其中**:
- `T`: 信任度 (Trust)
- `I`: 不确定度 (Uncertainty)
- `γ` (gamma): 不确定度影响系数（默认值 **0.2**）

### 2.2 主观意见三元组

主观逻辑中，节点间的评价用三元组表示：

```
ω = (T, D, I)
```

**约束条件**:
```
T + D + I = 1
T, D, I ∈ [0, 1]
```

**参数说明**:
- `T`: 信任度 (Trust)
- `D`: 否定度 (Distrust)
- `I`: 不确定度 (Uncertainty)

---

## 🔗 三、直接信誉计算

### 3.1 直接意见计算

节点 `j` 对节点 `i` 的直接意见:

```
ω^dir_{j→i} = (T^dir, D^dir, I^dir)
```

#### 不确定度 `I^dir`

```
I^dir = 2 / (2 + N)
```

**其中**:
- `N`: 总交互次数 = PosEvents + NegEvents

#### 信任度 `T^dir` 和 否定度 `D^dir`

```
T^dir = (1 - I^dir) × α / (α + β)

D^dir = (1 - I^dir) × β / (α + β)
```

**其中**:
```
α = (1 - θ) × PosEvents
β = θ × NegEvents
```

**θ (theta) 计算**:
```
θ = μ / (1 + e^(Σ(δ_k × NegEvents_k) / Σδ_k))
```

**参数说明**:
- `μ` (mu): Pearl增长曲线调整因子（默认值 **1.5**）
- `δ_k`: 第k次交互的权重
- `PosEvents`: 正面事件数量
- `NegEvents`: 负面事件数量

### 3.2 直接意见权重 `δ`

直接意见的权重由三个因素组成：

```
δ = ρ1·Fi + ρ2·TIM + ρ3·Sim
```

**约束条件**:
```
ρ1 + ρ2 + ρ3 = 1
```

**参数说明**（默认值）:
- `ρ1 = 0.4`: 交互频率权重
- `ρ2 = 0.4`: 时效性权重
- `ρ3 = 0.2`: 轨迹相似度权重

#### 3.2.1 交互频率因子 `Fi`

```
Fi = N_ij / N_avg
```

**其中**:
- `N_ij`: 节点i与节点j的交互次数
- `N_avg`: 所有节点对的平均交互次数

#### 3.2.2 时效性因子 `TIM`

```
TIM = η × Δt^(-ε)
```

**其中**:
- `η` (eta): 时效性基础系数（默认值 **1.0**）
- `Δt`: 距离上次交互的时间间隔（秒）
- `ε` (epsilon): 时间衰减指数（默认值 **0.5**）

**特殊情况**:
```
如果 Δt ≤ 0 (当前交互):
    TIM = η
```

#### 3.2.3 轨迹相似度 `Sim`

```
Sim = τ1·Sim_speed + τ2·Sim_direction + τ3·Sim_acceleration
```

**约束条件**:
```
τ1 + τ2 + τ3 = 1
```

**参数说明**（默认值）:
- `τ1 = 0.4`: 速度相似度权重
- `τ2 = 0.4`: 方向相似度权重
- `τ3 = 0.2`: 加速度相似度权重

**余弦相似度计算**:
```
Sim_x = (A · B) / (||A|| × ||B||)

其中:
  A · B = Σ(a_i × b_i)
  ||A|| = √(Σ(a_i²))
  ||B|| = √(Σ(b_i²))
```

---

## 🔀 四、间接信誉计算

### 4.1 折扣算子 (Discounting)

节点 `j` 通过中间节点 `m` 对节点 `i` 的间接意见：

```
ω^ind_{j→i} = ω_{j→m} ⊗ ω_{m→i}
```

**折扣运算**:
```
T^new = T_1 × T_2
D^new = T_1 × D_2
I^new = D_1 + I_1 + T_1 × I_2
```

### 4.2 多跳路径聚合

对于多条从 `j` 到 `i` 的路径，使用加权平均：

```
ω^ind_{j→i} = Σ(w_k × ω_k) / Σw_k
```

**其中**:
- `w_k`: 第k条路径的权重 = 路径上所有直接权重的乘积
- `ω_k`: 第k条路径的意见（通过连续折扣运算得到）

---

## 🔄 五、意见融合

### 5.1 直接意见聚合

多个节点对同一目标的直接意见聚合：

```
ω^dir_C = Σ(δ_k × ω^dir_k) / Σδ_k
```

**其中**:
- `δ_k`: 第k个直接意见的权重
- `ω^dir_k`: 第k个直接意见

### 5.2 间接意见聚合

多个节点的间接意见简单平均：

```
ω^ind_C = (1/n) × Σω^ind_k
```

### 5.3 共识算子 (Consensus)

融合直接意见和间接意见：

```
ω^final = ω^dir_C ⊕ ω^ind_C
```

**共识运算公式**:
```
k = I^dir × I^ind + T^ind × I^dir + D^ind × I^dir

T^final = (T^dir × I^ind + T^ind × I^dir) / k

D^final = (D^dir × I^ind + D^ind × I^dir) / k

I^final = (I^dir × I^ind) / k
```

---

## ⚡ 六、紧急交易权重改进（新增）

### 6.1 交易类型权重计算

根据交易类型调整信誉影响的权重：

```
W = CalculateTransactionWeight(txType, ED)
```

#### 6.1.1 普通交易

```
W_normal = 1.0
```

#### 6.1.2 紧急交易

```
W_emergency = EmergencyTxBaseWeight × (1 + α × ED)

上限约束: W_emergency ≤ MaxWeightMultiplier
```

**参数值**（**加强版**）:
- `EmergencyTxBaseWeight = 3.0`: 紧急交易基础权重
- `α = UrgencyImpactFactor = 0.8`: 紧急度影响系数
- `MaxWeightMultiplier = 8.0`: 最大权重倍数

### 6.2 最终信誉影响权重

将交易类型权重应用到直接意见权重：

```
δ_final = δ_base × W
```

**其中**:
- `δ_base`: 原始直接意见权重（由交互频率、时效性、轨迹相似度计算）
- `W`: 交易类型权重

### 6.3 权重计算示例

**示例1**: 普通交易

```
δ_base = 0.8 (原始权重)
W = 1.0 (普通交易)

δ_final = 0.8 × 1.0 = 0.8
```

**示例2**: 紧急交易（紧急度=2.0）

```
δ_base = 0.8
ED = 2.0

W = 3.0 × (1 + 0.8 × 2.0)
  = 3.0 × 2.6
  = 7.8

δ_final = 0.8 × 7.8 = 6.24
```

**效果**: 紧急交易的影响是普通交易的 **7.8倍**！

---

## 📝 七、完整计算流程

### 7.1 紧急交易处理流程

```
1. 车辆生成紧急交易 (tp)
   ↓
2. 交易到达RSU (ta)
   ↓
3. 计算紧急度 ED
   ED = e^(-(td-ta)/(ta-tp)) × e^(ω·θ)
   ↓
4. 添加到交易池，按ED排序
   ↓
5. 验证器选取高ED交易打包
   ↓
6. PBFT共识验证
   ↓
7. 验证器对交易发送者评价
   计算交易类型权重 W
   ↓
8. 更新发送者信誉值
   使用加权后的意见 (δ_final = δ_base × W)
```

### 7.2 信誉值计算流程

```
1. 收集交互记录
   Interactions = {(from, to, pos, neg, timestamp, txType, ED)}
   ↓
2. 按节点对聚合
   Aggregate by (to, from)
   ↓
3. 计算直接意见
   For each (to, from):
     - 计算 Fi, TIM, Sim
     - 计算 δ_base = ρ1·Fi + ρ2·TIM + ρ3·Sim
     - 计算 W (根据txType和ED)
     - 计算 δ_final = δ_base × W
     - 计算 I^dir = 2/(2+N)
     - 计算 θ, α, β
     - 计算 T^dir, D^dir
   ↓
4. 计算间接意见
   For each path j→m→...→i:
     - 应用折扣算子
     - 加权聚合多条路径
   ↓
5. 融合意见
   - 聚合直接意见 ω^dir_C
   - 聚合间接意见 ω^ind_C
   - 应用共识算子 ω^final = ω^dir_C ⊕ ω^ind_C
   ↓
6. 计算最终信誉值
   R = T^final + γ·I^final
```

---

## 📊 八、参数配置总表

### 8.1 紧急度评估参数

| 参数 | 符号 | 默认值 | 说明 |
|------|------|-------|------|
| 影响权重 | ω | 0.5 | 已申请交易数量的影响 |

### 8.2 信誉值计算参数

| 参数 | 符号 | 默认值 | 说明 |
|------|------|-------|------|
| 不确定度影响系数 | γ | 0.2 | 不确定度对信誉的影响 |
| Pearl调整因子 | μ | 1.5 | 错误事件的影响调整 |
| 交互频率权重 | ρ1 | 0.4 | 交互频率在权重中的占比 |
| 时效性权重 | ρ2 | 0.4 | 时效性在权重中的占比 |
| 轨迹相似度权重 | ρ3 | 0.2 | 轨迹相似度在权重中的占比 |
| 时效性基础系数 | η | 1.0 | 时效性因子的基础值 |
| 时间衰减指数 | ε | 0.5 | 时间对时效性的影响 |
| 速度相似度权重 | τ1 | 0.4 | 速度在轨迹相似度中的占比 |
| 方向相似度权重 | τ2 | 0.4 | 方向在轨迹相似度中的占比 |
| 加速度相似度权重 | τ3 | 0.2 | 加速度在轨迹相似度中的占比 |

### 8.3 紧急交易权重参数（加强版）

| 参数 | 符号 | 默认值 | 说明 |
|------|------|-------|------|
| 普通交易权重 | W_normal | 1.0 | 普通交易的基础权重 |
| 紧急交易基础权重 | EmergencyTxBaseWeight | 3.0 | 紧急交易的基础倍数 |
| 紧急度影响系数 | UrgencyImpactFactor | 0.8 | 紧急度对权重的影响 |
| 最大权重倍数 | MaxWeightMultiplier | 8.0 | 权重的上限值 |

---

## 💡 九、关键公式速查表

### 紧急度评估

```
ED = e^(-(td-ta)/(ta-tp)) × e^(ω·θ)
```

### 信誉值计算

```
R = T + γ·I
```

### 直接意见权重

```
δ = ρ1·Fi + ρ2·TIM + ρ3·Sim
```

### 交易类型权重

```
W_emergency = 3.0 × (1 + 0.8 × ED),  W ≤ 8.0
```

### 最终影响权重

```
δ_final = δ_base × W
```

### 主观意见三元组

```
T + D + I = 1
```

### 共识算子

```
k = I^dir·I^ind + T^ind·I^dir + D^ind·I^dir
T^final = (T^dir·I^ind + T^ind·I^dir) / k
D^final = (D^dir·I^ind + D^ind·I^dir) / k
I^final = (I^dir·I^ind) / k
```

---

## 📚 十、代码实现位置

### 紧急度评估

**文件**: `emergency/transaction.go`

```go
func (tx *EmergencyTransaction) CalculateUrgencyDegree(cfg UrgencyConfig) {
    Tc := tx.DeadlineTime.Sub(tx.ArrivalTime).Seconds()
    TrMinusTu := tx.ArrivalTime.Sub(tx.ProductTime).Seconds()
    
    E := math.Exp(-Tc / TrMinusTu)
    theta := float64(tx.Theta)
    tx.UrgencyDegree = E * math.Exp(cfg.Omega*theta)
}
```

### 交易类型权重

**文件**: `reputation/reputation.go`

```go
func CalculateTransactionWeight(txType TransactionType, urgencyDegree float64) float64 {
    switch txType {
    case NormalTransaction:
        return NormalTxWeight
    case EmergencyTransaction:
        weight := EmergencyTxBaseWeight * (1.0 + UrgencyImpactFactor*urgencyDegree)
        if weight > MaxWeightMultiplier {
            weight = MaxWeightMultiplier
        }
        return weight
    }
}
```

### 信誉值计算

**文件**: `reputation/reputation.go`

```go
func (rm *ReputationManager) ComputeReputation(target string, now time.Time) float64 {
    agg := rm.aggregateByPair()
    direct := rm.computeDirectOpinions(agg, now)
    indirect := rm.computeIndirectOpinions(direct)
    final := rm.fuseOpinions(direct[target], indirect[target])
    return final.T + rm.cfg.Gamma*final.I
}
```

---

## 🎯 十一、实际计算示例

### 完整案例：恶意节点在紧急交易中作恶

**初始条件**:
- 节点A（恶意）发送紧急交易
- 验证器B检测到恶意行为
- 紧急度 ED = 2.5

**步骤1: 计算紧急度**
```
tp = 10:00:00.000
ta = 10:00:00.050 (延迟50ms)
td = 10:00:00.300 (期望300ms完成)
θ = 3 (已申请3次)
ω = 0.5

Tc = 0.3 - 0.05 = 0.25秒
Tr - Tu = 0.05秒

E = e^(-0.25/0.05) = e^(-5) ≈ 0.00674
ED = 0.00674 × e^(0.5×3) = 0.00674 × 4.48 ≈ 0.0302
```

**步骤2: 计算基础权重**
```
Fi = 5/3 = 1.67 (交互次数为5，平均为3)
TIM = 1.0 × 0.1^(-0.5) = 3.16 (距上次交互0.1秒)
Sim = 0.85 (轨迹相似度)

δ_base = 0.4×1.67 + 0.4×3.16 + 0.2×0.85
       = 0.668 + 1.264 + 0.17
       = 2.102
```

**步骤3: 计算交易类型权重**
```
W = 3.0 × (1 + 0.8 × 2.5)
  = 3.0 × 3.0
  = 9.0 → 8.0 (达到上限)
```

**步骤4: 计算最终权重**
```
δ_final = 2.102 × 8.0 = 16.816
```

**步骤5: 计算主观意见**
```
N = 1 (1次负面事件)
I = 2/(2+1) = 0.667

θ = 1.5 / (1 + e^(16.816×1/16.816))
  = 1.5 / (1 + e^1)
  = 1.5 / 3.718
  ≈ 0.403

α = (1-0.403) × 0 = 0
β = 0.403 × 1 = 0.403

T = (1-0.667) × 0/(0+0.403) = 0
D = (1-0.667) × 0.403/(0+0.403) = 0.333
I = 0.667
```

**步骤6: 计算信誉值变化**
```
假设原信誉值 R_old = 0.500

经过融合后（简化）:
T_final ≈ 0
D_final ≈ 0.333
I_final ≈ 0.667

R_new = 0 + 0.2×0.667 = 0.133

信誉下降 = 0.500 - 0.133 = 0.367 (下降73.4%)
```

**结论**: 一次高紧急度的恶意交易就能让信誉值大幅下降！

---

**文档版本**: v1.2  
**创建日期**: 2024年10月24日  
**最后更新**: 2024年10月24日  
**系统版本**: 双链区块链系统 + 紧急交易权重加强版

